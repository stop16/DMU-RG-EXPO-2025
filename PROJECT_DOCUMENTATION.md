# DMU-RG EXPO 2025 – 프로젝트 문서 (PROJECT_DOCUMENTATION_KR)

이 문서는 EXPO 데모 시스템의 **전체 구조, 하드웨어/소프트웨어 구성, 설치·실행 방법**을 한눈에 볼 수 있도록 정리했습니다.
신규 참여자도 이 문서만 보고 기본 동작 확인이 가능하도록 **단계별 절차**로 작성했습니다.

---

## 1. 시스템 한눈에 보기

* PC 한 대에서 여러 개의 **아두이노**를 **USB 시리얼**로 연결해 제어합니다.
* 각 보드는 전원이 들어오면 **자기 역할(ID)** 을 PC에 알려줍니다.
* **Python 스크립트**가 연결된 보드들을 자동으로 찾고(**activate**), 역할을 배정한 뒤
  **LED 효과, 도트매트릭스 문구, 지진(서보) 시뮬레이션, RC카 트리거**를 순서대로 실행합니다.

핵심 포인트

* **보드 4종류(Type 1~4)** 로 구성: LED, 지진 장치, 도트매트릭스, RC/ToF
* **펌웨어(Arduino)** 와 **호스트 제어(Python)** 가 **시리얼 프로토콜**로 통신
* **자동 시연 스크립트**와 **수동 점검 스크립트** 두 가지 흐름 지원

---

## 2. 저장소 구조

```
.
├─ Arduino/                 # 각 보드용 펌웨어
│  ├─ Merge/                # 실제 사용(통합) 스케치
│  └─ Testcode/             # 부품별 단품 테스트용 스케치
├─ Python/                  # 호스트 측 제어 스크립트
│  ├─ automation_test.py    # 자동 시연(원버튼)
│  ├─ expo_device_manager.py# 장치 연결/동기화 핵심 로직
│  ├─ integration_test.py   # 수동 통합 테스트(메뉴)
│  ├─ test.py               # 포트/역할 스모크 테스트
│  └─ rg_gui/               # PySide6 GUI 프로토타입(선택)
├─ README.md
└─ PROJECT_DOCUMENTATION.md (본 문서)
└─ MAINTENANCE_MANUAL.md
```

---

## 3. 하드웨어 구성(보드 역할)

| 타입     | 응답 바이트 | 수량 | 역할                 | 주요 주변장치        |
| ------ | ------ | ------ | ------------------ | -------------- |
| Type 1 | `'6'`  | 1      | LED 스트립(환경 조명)     | LED 스트립 2채널    |
| Type 2 | `'7'`  | 1      | **지진 장치** + 보조 LED | 서보 3개, LED 스트립 |
| Type 3 | `'8'`  | 3    | **도트매트릭스**(안내 문구)  | 32×16 매트릭스 1개/보드 |
| Type 4 | `'9'`  | 1      | **RC/ToF 센서 게이트**  | ToF 거리 센서      |

> PC에서 각 포트에 `q`를 보내면 보드가 `'6'~'9'` 중 하나를 회신합니다.
> Python은 이 응답으로 **자동 매핑**을 수행합니다.

---

## 4. 펌웨어(Arduino/) 사용법

* **Merge/** : 실제 행사에서 쓸 **완성 스케치**(타입별).
* **Testcode/** : LED, 도트매트릭스, 서보, ToF 등 **단품 테스트용**.
* Arduino IDE에서 각 `.ino` 열기 → 보드/포트 선택 → **업로드**.

팁

* 업로드 후 **시리얼 모니터**에서 `q` 전송 → `'6/7/8/9'` 응답 확인하기

---

## 5. Python 제어 스택(Python/)

### 5.1 핵심 클래스: `expo_device_manager.py`

기능 요약

* `connect()` : 지정된 포트 목록에 시리얼 연결
* `activate()` : 각 보드에 `q` 전송 → 역할 자동 인식
* `set_led() / set_dot_matrix() / toggle_animation() / set_earthquake()` : 장치 제어
* `start_demo_sequence()` : 자동 시연 스레드 시작(지진→알림→복구 흐름)
* **백그라운드 스레드**: 도트매트릭스 **주기 동기화**, 지진 타이머 등

> 내부 상태를 캐시해 **주기적 재동기화** 및 **안전 정지**가 가능하도록 설계됨.

### 5.2 자동 시연: `automation_test.py`

* **원버튼 데모**: 포트 설정 → 연결/활성화 → 초기화 → 자동 시연 → 정리
* `PORT_LIST`만 맞으면 **행사장에서 그대로 실행** 가능
* 종료 시에는 데모 스레드가 끝났는지 확인(추가 `stop_demo_sequence()` 지원 예정)

### 5.3 수동 통합: `integration_test.py`

* 메뉴 기반으로 **LED/도트/서보/센서** 수동 제어
* **펌웨어 합/맞춤** 작업이나 현장 보정에 적합

### 5.4 스모크 테스트: `test.py`

* 포트 나열, 역할 응답 확인, 간단한 제어 커맨드 전송
* **배선 작업 직후** 빠르게 건전성 체크

### 5.5 실행 환경

* Python **3.12** 권장
* 필수 패키지: `pyserial`
* 빠른 설치 예시

  ```bash
  cd Python
  python -m venv .venv
  . ./.venv/Scripts/activate
  pip install pyserial
  ```

---

## 6. 빠른 시작(Quick Start)

1. **펌웨어 업로드**

* `Arduino/Merge/`에서 각 타입별 스케치 업로드
* 시리얼 모니터에서 `q` → `'6/7/8/9'` 응답 확인

2. **연결 & 포트 기록**

* 모든 보드를 USB로 PC에 연결
* 장치 관리자에서 COM 순서 확인 → `PORT_LIST`에 반영
  (케이블에 **역할 라벨** 붙이면 재연결 시 편함)

3. **가상환경 & 의존성 설치**

```bash
cd Python
. ./.venv/Scripts/activate   # (없으면 위 5.6 참고해 생성)
pip install pyserial PySide6
```

4. **스모크 테스트**

```bash
python test.py
```

* 모든 보드가 응답하는지, 간단 제어가 되는지 확인

5. **리허설(자동 시연)**

```bash
python automation_test.py
```

* 콘솔에서 **“Connected”**, **“지진 발생”**, 센서 `'o'` 수신 등을 확인

6. **현장 운영**

* 자동 시연 스크립트를 실행해두고 **로그만 모니터링**
* 문제 생기면 `integration_test.py`로 해당 파트만 분리 점검

---

## 7. 시리얼 프로토콜 요약

**Host → Device**

* `q` : 역할 물어보기(보드는 `'6'~'9'`로 응답)
* `r` / `g` / `a` : LED 빨강/초록/끄기
* `c` / `n` / `v` : 도트매트릭스 “통신중/통신불가/복구중”
* `m` : 도트매트릭스 애니메이션 토글
* `1` `2` `0` `3` : 지진 장치(시작/진동/정지/핀올림)

**Device → Host**

* `'6'~'9'` : 활성화 시 역할 식별 응답
* `'o'` : RC카 ToF 센서 감지 신호

---

## 8. 테스트·문제해결 빠른 가이드

* **단품 확인은 Arduino/Testcode/** 스케치로
* **배선 바꾼 뒤엔 무조건 `test.py`**
* **표시/타이밍 재동기화**는 `expo_device_manager.py`의 로그로 확인
* **자주 보는 이슈**

  * 자동 시연 중 멈춤 → **COM 순서** 재확인, 케이블 재삽입
  * 도트매트릭스 미갱신 → Type 3 매핑 누락 여부 확인, 간단 명령(`c/n/v/m`) 재전송
  * 지진 장치 즉시 중단 → 이벤트 충돌 여부 확인 후 재실행, 시연환경 재부팅
  * LED 깜빡임 → **전원 강하/접지** 점검, 서보 부하 줄이고 재확인

> 자세한 대응표와 주기 점검은 **MAINTENANCE_MANUAL.md** 참고 

---

## 9. 변경(펌웨어/프로토콜) 시 권고사항

1. **문서화 먼저**: 새 명령·역할을 본 문서 하단과 코드 주석에 기록
2. **병행 수정**: Arduino와 Python을 **같은 브랜치**에서 동시 변경
3. **책상 위 검증 → 통합 검증** 순서
